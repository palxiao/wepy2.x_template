
<wxs module="m1" lang="babel" src="../utils/widget/test.wxs"></wxs>
<template>
  <movable-area style="min-height:{{wHeight}}px;" class="container">

    <!-- <button class="head" open-type="getUserInfo" lang="zh_CN" bindgetuserinfo="onGotUserInfo">
      <div class="userinfo">
        <image class="userinfo-avatar" src="{{ userInfo.avatarUrl }}" background-size="cover" />
        <div class="userinfo-nickname">{{ userInfo.nickName }}</div>
      </div>
    </button> -->

    <!-- <my-swiper @tap="openEditor" @change="swiperChange" :imgUrls="imgUrls" /> -->
    <image mode="aspectFill" class="bg" style="min-height:{{wHeight}}px" src="../assets/images/bg00.png" />
    <image @tap="add" :animation="act" mode="aspectFit" class="title" src="../assets/images/title.png" />
    <div @tap="add" class="add"> + 点击添加目标</div>
    <image class="bottom-image" mode="aspectFit" src="../assets/images/bg02.png" />

    <scroll-view scroll-y="true" class="content" style="height:{{wHeight*0.68}}px;">
      <!-- bindscrolltoupper="upper" bindscrolltolower="lower" bindscroll="scroll" scroll-into-view="{{toView}}" scroll-top="{{scrollTop}}" -->
      <!-- <checkbox-group bindchange="checkboxChange"> -->
      <!-- v-if="!item.checked" -->
      <div class="checkbox" v-for="(item,index) in items" :key="'do'+index" bindlongpress="_longtap" bindtouchstart="touchs(index)"
        bindtouchend="touchend" bindtouchmove="touchm">
        <checkbox @tap="checkboxSelect(index)" :value="item.value" :checked="item.checked" />
        <input v-if="item.edit" class="defalut" :focus="item.edit" bindblur="blur(index)" v-model="item.value"
          :placeholder="pihua" />
        <text v-else @tap="edit(index)" class="{{item.checked?'del':'defalut'}}">{{item.value}}</text>
      </div>

      <!-- </checkbox-group> -->
      <div class="checkbox-done" v-for="(ditem,dindex) in complete" :key="'done'+dindex">
        <checkbox @tap="checkboxSelect(dindex, true)" :value="ditem.value" :checked="ditem.checked" />
        <text class="del">{{ditem.value}}</text>
      </div>

      <movable-view :out-of-bounds="true" :x="x" :y="y" direction="vertical" :damping="5000" :friction="1" :disabled="disabled">
        <view :hidden="!flag" class="move-box">{{flag}}</view>
      </movable-view>
    </scroll-view>

    <movable-view @tap="authorize" direction="all" :inertia="true" :y="wHeight" class="daka">
      <text class="icon yy-zhuanhuan"></text><text style="line-height: 50rpx;">同步/打卡</text>
    </movable-view>

    <!-- <official-account style="margin-top:40rpx;"></official-account> -->

  </movable-area>
</template>

<script>
import wepy from '@wepy/core'
import eventHub from '../utils/common/eventHub'
// import { mapState, mapActions } from '@wepy/x';
import store from '@/store'
// import testMixin from '../mixins/test';
import api from '@/api'
import { vibrate } from '@/utils'
const system = wx.getSystemInfoSync()
let elements = []
let animation = null
wepy.page({
  store,

  hooks: {
    // Page 级别 hook, 只对当前 Page 的 setData 生效。
  },

  // mixins: [testMixin],

  data: {
    x: 0,
    y: 0,
    beginIndex: 0,
    disabled: false,
    flag: null,
    current: '',
    pihua: '',
    wHeight: system.windowHeight,
    userInfo: {
      nickName: '请登录'
    },
    items: [],
    complete: [],
    act: {}
  },

  created() {
    const read_items = wx.getStorageSync('items')
    this.items = read_items || [] // 拉取缓存数据
    const read_complete = wx.getStorageSync('complete')
    this.complete = read_complete || []

    this.$nextTick(() => {
      this.initDOMTree()

      animation = wx.createAnimation({
        duration: 200,
        timingFunction: 'ease' // 'linear'
      })
    })

    this.getUser()
  },

  computed: {},

  methods: {
    // 初始化
    initDOMTree() {
      const query = wx.createSelectorQuery()
      const nodesRef = query.selectAll('.checkbox')
      const params = {
        dataset: true,
        rect: true
      }
      nodesRef
        .fields(params, res => {
          elements = res
        })
        .exec()
    },
    // 列表操作
    _longtap: function(e) {
      vibrate()
      e = e.$wx
      const detail = e.detail
      this.x = e.currentTarget.offsetLeft
      this.y = e.currentTarget.offsetTop
      this.flag = this.current
    },
    touchs: function(index) {
      this.current = this.items[index].value
      this.beginIndex = index
    },
    // 触摸结束
    touchend: function(e) {
      e = e.$wx
      if (!this.flag) {
        return
      }
      // const x = e.changedTouches[0].pageX
      const y = e.changedTouches[0].pageY
      const list = elements
      let data = this.items
      for (var j = 0; j < list.length; j++) {
        const item = list[j]
        if (
          // x > item.left &&
          // x < item.right &&
          y > item.top &&
          y < item.bottom
        ) {
          const endIndex = j
          const beginIndex = this.beginIndex
          // 向后移动
          if (beginIndex < endIndex) {
            let tem = data[beginIndex]
            for (let i = beginIndex; i < endIndex; i++) {
              data[i] = data[i + 1]
            }
            data[endIndex] = tem
          }
          // 向前移动
          if (beginIndex > endIndex) {
            let tem = data[beginIndex]
            for (let i = beginIndex; i > endIndex; i--) {
              data[i] = data[i - 1]
            }
            data[endIndex] = tem
          }
          this.items = JSON.parse(JSON.stringify(data.slice()))
          this.syncData()
        }
      }
      this.flag = false
    },
    // 滑动
    touchm: function(e) {
      e = e.$wx
      if (this.flag) {
        const x = e.touches[0].pageX
        const y = e.touches[0].pageY
        this.y = y - 180
      }
    },

    // 列表增删改
    add() {
      const items = [
        '思考目标对未来发展的影响',
        '列出一件件你想做的事',
        '编辑时删除所有文字可删除该目标',
        '长按目标可以排序',
        '比方说先挣他一个亿',
      ]
      this.pihua = items[Math.floor(Math.random() * items.length)]

      animation.scale(1.12).step()
      this.act = animation.export()
      setTimeout(() => {
        animation.scale(1).step()
        this.act = animation.export()
      }, 200)
      vibrate()

      this.items.push({ value: '', checked: false, edit: true })
      setTimeout(() => {
        this.initDOMTree()
      }, 1000)
    },
    checkboxChange(e) {
      console.log('checkbox发生change事件，携带value值为：', e.$wx.detail.value)
    },
    checkboxSelect(index, idDone) {
      if (idDone) {
        wx.showToast({
          title: '这个目标已经达成了',
          icon: 'none'
        })
        this.complete[index].checked = true
        this.complete = this.complete.slice()
      } else {
        // this.items[index].checked = true // 出错
        const _this = this
        wx.showModal({
          content: '是否完成了该目标',
          success(res) {
            if (res.confirm) {
              const tempObj = {}
              tempObj.checked = true
              tempObj.value = _this.items[index].value
              _this.complete.push(tempObj)
              console.log('删除' + index)
              _this.items.splice(index, 1)
              _this.syncData()
            } else {
              _this.items[index].checked = false
              _this.items = _this.items.slice()
            }
          }
        })
      }
    },
    edit(index) {
      if (this.items[index]) this.items[index].edit = true
    },
    blur(index) {
      if (!this.items[index]) {
        return
      }
      if (!this.items[index].value) {
        this.items.splice(index, 1)
      } else {
        this.items[index].edit = false
      }
      this.syncData()
    },
    syncData() {
      setTimeout(() => {
        wx.setStorageSync('items', this.items)
        wx.setStorageSync('complete', this.complete)
      }, 800)
    },
    // ...mapActions(['']) ,
    getUser() {
      const _this = this
      wx.getUserInfo({
        success(res) {
          _this.userInfo = res.userInfo
          _this.$app.$options.globalData.userInfo = res.userInfo
        }
      })
    },
    onGotUserInfo: e => {},
    authorize() {
      wx.navigateTo({
        url: 'authorization' // 授权
      })
    }
  },
  events: {}
})
</script>
<style lang="less">
@import url('../assets/styles/index.less');
@import url('~@/assets/styles/iconfont/iconfont.less');
</style>
<config>
{
    navigationBarTitleText: '🐸',
    disableScroll: true,
    usingComponents: {
      "my-swiper": "~@/components/common/Swiper",
    }
}
</config>
